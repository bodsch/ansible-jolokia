---

- name: create deployment temporary directory
  file:
    path: "{{ deployment_tmp_directory }}"
    state: directory
    mode: 0750

- name: create local temporary directory
  become: false
  file:
    path: "{{ local_tmp_directory }}"
    state: directory
    mode: 0750
  delegate_to: localhost

- name: download tomcat binary to local folder
  become: false
  get_url:
    url: "{{ tomcat_download_url }}"
    dest: "{{ local_tmp_directory }}/apache-tomcat-{{ tomcat_version }}.tar.gz"
  register: _download_archive
  until: _download_archive is succeeded
  retries: 5
  delay: 2
  # run_once: true
  delegate_to: localhost
  check_mode: false
  tags:
    - tomcat

- name: propagate tomcat archiv
  copy:
    src: "{{ local_tmp_directory }}/apache-tomcat-{{ tomcat_version }}.tar.gz"
    dest: "{{ deployment_tmp_directory }}"
  tags:
    - tomcat

- name: check for unpacked tomcat
  stat:
    path: "{{ jolokia_home }}/apache-tomcat-{{ tomcat_version }}"
  register: _tomcat_unpack


- block:

    - name: unpack tomcat binary
      unarchive:
        src: "{{ deployment_tmp_directory }}/apache-tomcat-{{ tomcat_version }}.tar.gz"
        dest: "{{ jolokia_home }}/"
        owner: "{{ jolokia_user }}"
        group: "{{ jolokia_group }}"
        mode: 0750
        copy: false

    - name: create current link for tomcat
      file:
        src: "{{ jolokia_home }}/apache-tomcat-{{ tomcat_version }}"
        dest: "{{ jolokia_home }}/current"
        state: link
        force: true
        follow: false
        mode: 0640

    - name: remove default webapps
      file:
        name: "{{ jolokia_home }}/current/webapps/{{ item }}"
        state: absent
      loop:
        - docs
        - examples
        - host-manager
        - manager
        - ROOT

  when: _tomcat_unpack.stat is defined and not _tomcat_unpack.stat.exists
